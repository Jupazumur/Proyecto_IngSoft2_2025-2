<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Nuevo Componente</title>
    <style>
        body{font-family:sans-serif;padding:20px}
        .form-field {margin-bottom:15px}
        .form-field label {display:block;margin-bottom:5px;font-weight:bold}
        .formulario-field-container {display:flex;align-items:flex-start;gap:10px}
        .formulario-field-container select {flex:1}
        .formulario-field-container a {padding:6px 12px;text-decoration:none;background-color:#007bff;color:white;border-radius:4px;white-space:nowrap}
        .formulario-field-container a:hover {background-color:#0056b3}
    </style>
</head>
<body>
    <h1>{% if componente %}Editar componente para: {{ actividad.titulo }}{% else %}Nuevo componente para: {{ actividad.titulo }}{% endif %}</h1>
    <form method="post">
        {% csrf_token %}
        
        {% if not componente %}
        <div class="form-field">
            <label for="{{ form.tipo.id_for_label }}">{{ form.tipo.label }}</label>
            {{ form.tipo }}
            {% if form.tipo.errors %}
                <ul class="errorlist">
                    {% for error in form.tipo.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="form-field">
            <label for="{{ form.contenido.id_for_label }}">{{ form.contenido.label }}</label>
            {{ form.contenido }}
            {% if form.contenido.errors %}
                <ul class="errorlist">
                    {% for error in form.contenido.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        
        {% if not componente %}
        <div class="form-field" id="formulario-field-container">
            <label for="{{ form.formulario.id_for_label }}">{{ form.formulario.label }}</label>
            <div class="formulario-field-container">
                {{ form.formulario }}
                <a id="formulario-btn" href="{% if form.formulario.value %}{% url 'formulario:editar' pk=form.formulario.value %}{% else %}{% url 'formulario:nuevo' %}{% endif %}">
                    {% if form.formulario.value %}Editar formulario{% else %}Crear formulario{% endif %}
                </a>
            </div>
            {% if form.formulario.errors %}
                <ul class="errorlist">
                    {% for error in form.formulario.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        {% elif componente.tipo != "foro" %}
        <div class="form-field" id="formulario-field-container">
            <label for="{{ form.formulario.id_for_label }}">{{ form.formulario.label }}</label>
            <div class="formulario-field-container">
                {{ form.formulario }}
                <a id="formulario-btn" href="{% if form.formulario.value %}{% url 'formulario:editar' pk=form.formulario.value %}{% else %}{% url 'formulario:nuevo' %}{% endif %}">
                    {% if form.formulario.value %}Editar formulario{% else %}Crear formulario{% endif %}
                </a>
            </div>
            {% if form.formulario.errors %}
                <ul class="errorlist">
                    {% for error in form.formulario.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        {% endif %}
        
        <button type="submit">{% if componente %}Guardar cambios{% else %}Crear componente{% endif %}</button>
        <a href="{% url 'teaching_sequence' %}">Volver</a>
    </form>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% if not componente %}
            const tipoSelect = document.getElementById('{{ form.tipo.id_for_label }}');
            {% else %}
            const tipoSelect = null;
            {% endif %}
            const formularioFieldContainer = document.getElementById('formulario-field-container');
            const formularioSelect = document.getElementById('{{ form.formulario.id_for_label }}');
            const formularioBtn = document.getElementById('formulario-btn');
            const nuevoUrl = '{% url "formulario:nuevo" %}';
            
            // Función para mostrar/ocultar el campo formulario según el tipo seleccionado
            function toggleFormularioField() {
                if (tipoSelect && formularioFieldContainer) {
                    const tipoSeleccionado = tipoSelect.value;
                    if (tipoSeleccionado === 'foro') {
                        formularioFieldContainer.style.display = 'none';
                    } else {
                        formularioFieldContainer.style.display = 'block';
                    }
                }
            }
            
            // Si estamos creando un nuevo componente, escuchar cambios en el tipo
            {% if not componente %}
            if (tipoSelect) {
                // Aplicar la lógica al cargar la página
                toggleFormularioField();
                
                // Escuchar cambios en el dropdown de tipo
                tipoSelect.addEventListener('change', toggleFormularioField);
            }
            {% endif %}
            
            // Manejar cambios en el select de formulario
            if (formularioSelect && formularioBtn) {
                formularioSelect.addEventListener('change', function() {
                    const selectedValue = this.value;
                    if (selectedValue) {
                        formularioBtn.textContent = 'Editar formulario';
                        // Construir URL: /formulario/editar/<id>/
                        formularioBtn.href = '/formulario/editar/' + selectedValue + '/';
                    } else {
                        formularioBtn.textContent = 'Crear formulario';
                        formularioBtn.href = nuevoUrl;
                    }
                });
            }
        });
    </script>
</body>
</html>
